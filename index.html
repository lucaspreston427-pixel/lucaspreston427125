<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Roblox Shirt Generator Fixed v2</title>
<style>
body{font-family:sans-serif;max-width:1000px;margin:20px auto;padding:10px;}
h1{font-size:1.3rem;margin-bottom:10px;}
.panel{background:#f6f6f8;padding:12px;border-radius:8px;margin-bottom:12px;}
button,input{font-size:14px;margin:4px 0;padding:6px;border-radius:5px;}
canvas{border:1px solid #ccc;width:100%;height:auto;}
.texture-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.thumb{width:64px;height:64px;object-fit:cover;border:1px solid #ccc;border-radius:4px;cursor:pointer;}
.row{display:flex;gap:6px;align-items:center;margin:4px 0;}
</style>
</head>
<body>
<h1>Roblox Shirt Generator Fixed v2</h1>

<div class="panel">
  <h3>1) Upload Official Roblox Template</h3>
  <input type="file" id="templateUpload" accept="image/*">
</div>

<div class="panel">
  <h3>2) Add Textures</h3>
  <input type="file" id="file" accept="image/*" multiple>
  <div class="row">
    <input type="text" id="urlInput" placeholder="Paste image URL here" style="flex:1;">
    <button id="addURL">Add URL</button>
  </div>
  <button id="clear-textures">Clear Textures</button>
  <div class="texture-list" id="textureList"></div>
</div>

<div class="panel">
  <h3>3) Options</h3>
  <label class="row"><input type="checkbox" id="useCrop" checked> Randomly crop textures</label>
  <label class="row"><input type="checkbox" id="rotate"> Random rotate tiles</label>
  <label class="row">Tiles per area:
    <select id="tilesCount"><option>1</option><option>2</option><option>3</option><option>4</option></select>
  </label>
</div>

<div class="panel">
  <button id="generate">Generate Random Shirt</button>
  <button id="export">Export PNG</button>
</div>

<div class="panel">
  <h3>Preview</h3>
  <canvas id="canvas" width="1024" height="1024"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('file');
const textureListDiv = document.getElementById('textureList');
const addURLBtn = document.getElementById('addURL');
const urlInput = document.getElementById('urlInput');
const clearBtn = document.getElementById('clear-textures');
const generateBtn = document.getElementById('generate');
const exportBtn = document.getElementById('export');
const useCropCheck = document.getElementById('useCrop');
const rotateCheck = document.getElementById('rotate');
const tilesSelect = document.getElementById('tilesCount');
const templateUpload = document.getElementById('templateUpload');

let textures = [];
let templateImage = null;

// Load template and auto-remove white background
templateUpload.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.crossOrigin="anonymous";
  img.onload = () => {
    // Create temp canvas to remove white background
    const temp = document.createElement('canvas');
    temp.width = img.width; temp.height = img.height;
    const tctx = temp.getContext('2d');
    tctx.drawImage(img,0,0);
    const data = tctx.getImageData(0,0,temp.width,temp.height);
    for(let i=0;i<data.data.length;i+=4){
      const r = data.data[i], g = data.data[i+1], b = data.data[i+2];
      // treat nearly-white as transparent
      if(r>240 && g>240 && b>240){
        data.data[i+3] = 0;
      }
    }
    tctx.putImageData(data,0,0);
    const resultImg = new Image();
    resultImg.onload = () => { templateImage = resultImg; alert('Template loaded and white removed!'); };
    resultImg.src = temp.toDataURL();
  };
  img.src = URL.createObjectURL(file);
});

// Add textures from file
fileInput.addEventListener('change', e=>{
  const files = Array.from(e.target.files);
  files.forEach(f=>{
    const img = new Image();
    img.crossOrigin="anonymous";
    img.onload = ()=>{ textures.push({img,url:f.name}); renderTextureThumbs(); };
    img.src = URL.createObjectURL(f);
  });
  fileInput.value='';
});

// Add texture from URL
addURLBtn.addEventListener('click', ()=>{
  const url = urlInput.value.trim();
  if(!url) return;
  const img = new Image();
  img.crossOrigin="anonymous";
  img.onload = ()=>{ textures.push({img,url}); renderTextureThumbs(); };
  img.onerror = ()=>{ alert('Failed to load image from URL'); };
  img.src = url;
  urlInput.value='';
});

// Render thumbnails
function renderTextureThumbs(){
  textureListDiv.innerHTML='';
  textures.forEach((t,i)=>{
    const img = document.createElement('img');
    img.src = t.img.src;
    img.className='thumb';
    img.title = t.url;
    img.addEventListener('click', ()=>{if(confirm('Remove this texture?')){textures.splice(i,1); renderTextureThumbs();}});
    textureListDiv.appendChild(img);
  });
}

// Clear textures
clearBtn.addEventListener('click', ()=>{if(confirm('Clear all textures?')){textures=[]; renderTextureThumbs();}});

// Generate shirt
generateBtn.addEventListener('click', ()=>{
  if(!templateImage){ alert('Upload a template first'); return; }
  if(textures.length===0){ alert('Add at least one texture'); return; }

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Offscreen canvas for textures
  const off = document.createElement('canvas');
  off.width = canvas.width; off.height = canvas.height;
  const octx = off.getContext('2d');

  const tiles = parseInt(tilesSelect.value,10);
  for(let ty=0;ty<tiles;ty++){
    for(let tx=0;tx<tiles;tx++){
      const tex = textures[Math.floor(Math.random()*textures.length)];
      const img = tex.img;
      const dw = canvas.width/tiles;
      const dh = canvas.height/tiles;
      const dx = tx*dw;
      const dy = ty*dh;

      let sx=0,sy=0,sw=img.width,sh=img.height;
      if(useCropCheck.checked){
        const cropW = Math.floor(img.width*(0.3 + Math.random()*0.7));
        const cropH = Math.floor(img.height*(0.3 + Math.random()*0.7));
        sx = Math.floor(Math.random()*(img.width - cropW));
        sy = Math.floor(Math.random()*(img.height - cropH));
        sw = cropW; sh = cropH;
      }

      if(rotateCheck.checked && Math.random()>0.5){
        const tmp = document.createElement('canvas');
        tmp.width=sw; tmp.height=sh;
        const tctx = tmp.getContext('2d');
        tctx.drawImage(img,sx,sy,sw,sh,0,0,sw,sh);
        octx.save();
        octx.translate(dx+dw/2, dy+dh/2);
        octx.rotate(Math.random()*Math.PI*2);
        octx.drawImage(tmp,-dw/2,-dh/2,dw,dh);
        octx.restore();
      } else {
        octx.drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh);
      }
    }
  }

  // Apply template mask using source-in
  ctx.save();
  ctx.drawImage(templateImage,0,0,canvas.width,canvas.height);
  ctx.globalCompositeOperation='source-in';
  ctx.drawImage(off,0,0);
  ctx.restore();
});

// Export PNG
exportBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download='roblox_shirt.png';
  a.click();
});
</script>
</body>
</html>
